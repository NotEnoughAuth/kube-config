apiVersion: secrets.hashicorp.com/v1beta1
kind: VaultDynamicSecret
metadata:
  name: ghost-db-secret
  namespace: blog
spec:
  vaultAuthRef: ghost-kubernetes-auth
  mount: database
  path: creds/ghost_db_rw
  destination:
    create: true
    name: ghost-db-secret
  rolloutRestartTargets:
    - kind: Deployment
      name: ghost

---
# apiVersion: secrets.hashicorp.com/v1beta1
# kind: VaultStaticSecret
# metadata:
#   name: ghost-smtp-secret
#   namespace: blog
# spec:
#   vaultAuthRef: ghost-vault-auth
#   mount: kv
#   path: smtp/ghost
#   destination:
#     create: true
#     name: ghost-smtp-secret
#   refreshAfter: 1h

---
# apiVersion: secrets.hashicorp.com/v1beta1
# kind: VaultStaticSecret
# metadata:
#   name: ghost-config-prod
#   namespace: ghost-on-kubernetes
# spec:
#   vaultAuthRef: ghost-vault-auth
#   # doesn't matter what path here, we only need transform
#   mount: kv
#   path: dummy/path
#   destination:
#     create: true
#     name: ghost-config-prod
#     transformation:
#       templates:
#         config.production.json: |
#           {
#             "url": "https://yourdomain.tld",
#             "admin": {
#               "url": "https://yourdomain.tld"
#             },
#             "server": {
#               "port": 2368,
#               "host": "0.0.0.0"
#             },
#             "mail": {
#               "transport": "SMTP",
#               "from": "{{ .secrets.ghost-smtp-secret.data.username }}",
#               "options": {
#                 "service": "Google",
#                 "host": "{{ .secrets.ghost-smtp-secret.data.host }}",
#                 "port": 587,
#                 "secure": true,
#                 "auth": {
#                   "user": "{{ .secrets.ghost-smtp-secret.data.username }}",
#                   "pass": "{{ .secrets.ghost-smtp-secret.data.password }}"
#                 }
#               }
#             },
#             "logging": {
#               "transports": [
#                 "stdout"
#               ]
#             },
#             "database": {
#               "client": "mysql",
#               "connection": {
#                 "host": "{{ .secrets.ghost-db-secret.data.host }}",
#                 "user": "{{ .secrets.ghost-db-secret.data.username }}",
#                 "password": "{{ .secrets.ghost-db-secret.data.password }}",
#                 "database": "ghost",
#                 "port": "3306"
#               }
#             },
#             "process": "local",
#             "paths": {
#               "contentPath": "/home/nonroot/app/ghost/content"
#             }
#           }
#   refreshAfter: 1m
