apiVersion: apps/v1
kind: Deployment
metadata:
  name: oauth-proxy
  namespace: ms-sso
spec:
  replicas: 1
  selector:
    matchLabels:
      app: oauth-proxy
  template:
    metadata:
      labels:
        app: oauth-proxy
    spec:
      containers:
      - name: oauth-proxy
        image: quay.io/oauth2-proxy/oauth2-proxy:v7.2.0
        ports:
        - containerPort: 4180
        args:
        - --http-address=0.0.0.0:4180
        env:
        - name: OAUTH2_PROXY_PROVIDER
          value: "azure"
        - name: OAUTH2_PROXY_CLIENT_ID
          valueFrom:
            secretKeyRef:
              name: authenticationserver
              key: clientid
        - name: OAUTH2_PROXY_CLIENT_SECRET
          valueFrom:
            secretKeyRef:
              name: authenticationserver
              key: clientsecret
        - name: OAUTH2_PROXY_AZURE_TENANT
          valueFrom:
            secretKeyRef:
              name: authenticationserver-tennant
              key: tenant
        - name: OAUTH2_PROXY_COOKIE_SECRET
          valueFrom:
            secretKeyRef:
              name: authenticationserver
              key: jwtsecret
        - name: OAUTH2_PROXY_EMAIL_DOMAINS
          value: "*" # Adjust if you want to restrict to specific domains
        - name: OAUTH2_PROXY_REDIRECT_URL
          value: "https://auth.opryga.com/oauth2/callback" # Adjust to your OAuth Proxy's external URL